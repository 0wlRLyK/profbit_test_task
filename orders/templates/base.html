{% load functions %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}{% endblock %}</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"
            integrity="sha512-LGXaggshOkD/at6PFNcp2V2unf9LzFq6LE+sChH7ceMTDP0g2kn6Vxwgg7wkPP7AAtX+lmPqPdxB47A0Nz0cMQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/js/tempusdominus-bootstrap-4.min.js"
            integrity="sha512-k6/Bkb8Fxf/c1Tkyl39yJwcOZ1P4cRrJu77p83zJjN2Z55prbFHxPs9vN7q3l3+tSMGPDdoH51AEU8Vgo1cgAA=="
            crossorigin="anonymous"></script>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.min.css"
          integrity="sha512-3JRrEUwaCkFUBLK1N8HehwQgu8e23jTH4np5NHOmQOobuC4ROQxFwFgBLTnhcnQRMs84muMh0PnnwXlPq5MGjg=="
          crossorigin="anonymous"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/eonasdan-bootstrap-datetimepicker/4.17.49/css/bootstrap-datetimepicker.min.css"
          integrity="sha512-ipfmbgqfdejR27dWn02UftaAzUfxJ3HR4BDQYuITYSj6ZQfGT1NulP4BOery3w/dT2PYAe3bG5Zm/owm7MuFhA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <style>
        .header {
            position: sticky;
            top: 0;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="{% url "orders:by_time" %}">Отчёт по заказам за выбранный период времени</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url "orders:most_purchased" %}">Отчёт по самым покупаемым товарам</a>
            </li>
        </ul>
    </div>
</nav>
<div class="container-fluid">
    <div class="alert alert-primary d-flex align-items-center" role="alert">
        <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
            <symbol id="info-fill" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </symbol>
            <symbol id="exclamation-triangle-fill" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </symbol>
        </svg>
        <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Info:">
            <use xlink:href="#info-fill"/>
        </svg>
        <div>
            Всего было выполнено <strong id="top_query_counter">n</strong> запросов к базе данных.
        </div>
    </div>

    <div class='input-group mb-3'>
        <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
            <span class="input-group-text">Начальные дата и время:</span>
            <input class="form-control" type="text" name="picker_from" class="form-control datetimepicker-input"
                   data-target="#datetimepicker1"/>
            <button type="button" class="btn btn-outline-secondary" data-target="#datetimepicker1"
                    data-toggle="datetimepicker">
                <i class="fa fa-calendar"></i>
            </button>
        </div>
    </div>
    <div class='input-group mb-3'>

        <div class="input-group date" id="datetimepicker2" data-target-input="nearest">
            <span class="input-group-text">Конечные дата и время:</span>
            <input type="text" name="picker_to" class="form-control datetimepicker-input"
                   data-target="#datetimepicker2"/>
            <button type="button" class="btn btn-outline-secondary" data-target="#datetimepicker2"
                    data-toggle="datetimepicker">
                <i class="fa fa-calendar"></i>
            </button>
        </div>
    </div>
    {% block select %}

    {% endblock %}
    <div class="input-group mb-3">
        <button id="sendRequest" type="submit" class="btn btn-primary">Сгенерировать отчет</button>
    </div>
</div>
<table id="orders" class="table table-bordered table-hover ">
    {% block content %}{% endblock %}
</table>

<span id="real_query_counter" data-counter="{% db_queries_counter %}"></span>
<script>
    $("#top_query_counter").text($("#real_query_counter").data("counter"));
    $.fn.datetimepicker.Constructor.Default = $.extend({}, $.fn.datetimepicker.Constructor.Default, {
        icons: {
            time: 'far fa-clock',
            date: 'far fa-calendar',
            up: 'fas fa-arrow-up',
            down: 'fas fa-arrow-down',
            previous: 'fas fa-chevron-left',
            next: 'fas fa-chevron-right',
            today: 'far fa-calendar-check-o',
            clear: 'far fa-trash',
            close: 'far fa-times'
        }
    });
    const pickerConfigs = {
        format: 'DD.MM.YYYY HH:mm',
        locale: 'uk',

    };
    let fromDate = null,
        toDate;
    $(function () {
        $('#datetimepicker1').datetimepicker(Object.assign({
            defaultDate: moment({
                day: 1,
                month: 0,
                year: 2018,
                hour: 9
            }),
        }, pickerConfigs));
        $('#datetimepicker2').datetimepicker(Object.assign({
            useCurrent: false,
            defaultDate: moment({
                day: 1,
                month: 0,
                year: 2018,
                hour: 10
            }),
        }, pickerConfigs));
        $("#datetimepicker1").on("change.datetimepicker", function (e) {
            $('#datetimepicker2').datetimepicker('minDate', e.date);
        });
        $("#datetimepicker2").on("change.datetimepicker", function (e) {
            $('#datetimepicker1').datetimepicker('maxDate', e.date);
        });
    });

    function sendRequestByClick(buttonSelector, loadTo, type) {
        $(buttonSelector).on('click', function () {
            let fromDate = $('#datetimepicker1').datetimepicker('date').format('DD.MM.YYYY HH:mm'),
                toDate = $('#datetimepicker2').datetimepicker('date').format('DD.MM.YYYY HH:mm'),
                maxItems = $("#max_items_number").val(),
                params = null;
            if (type === "orders") {
                params = `?from=${fromDate}&to=${toDate}`
            } else if (type === "orderItems") {
                params = `?from=${fromDate}&to=${toDate}&slice=${maxItems}`
            }

            $.ajax({
                url: location.origin + location.pathname + params,
                type: "GET",
                success: function (data) {
                    let orders = $(data).filter(loadTo).html();
                    $(loadTo).html(orders);
                    window.history.pushState({"html": data.html, "pageTitle": data.pageTitle}, "", params)
                }
            })

        })
    }

    sendRequestByClick("#sendRequest", "#orders", "orderItems");
</script>
{% block javascript %}{% endblock %}
</body>
</html>